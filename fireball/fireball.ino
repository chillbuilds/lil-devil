#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>

#define i2c_Address 0x3c

#define SCREEN_WIDTH 128  // OLED display width, in pixels
#define SCREEN_HEIGHT 64  // OLED display height, in pixels
#define OLED_RESET -1     //   QT-PY / XIAO
Adafruit_SH1106G display = Adafruit_SH1106G(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);


const unsigned char fireball_bar [] PROGMEM = {
	// 62x11px
	0x00, 0x00, 0x00, 0x55, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2a, 0xa0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x55, 0x50, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xea, 0xbf, 0xff, 0xff, 0xf8, 
	0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x42, 0x10, 0x88, 0x88, 0x42, 0x10, 0x88, 
	0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xff, 0xff, 0xff, 0xea, 0xbf, 0xff, 0xff, 0xf8, 
	0x00, 0x00, 0x00, 0x55, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2a, 0xa0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x55, 0x50, 0x00, 0x00, 0x00
};
const unsigned char devil_head[] PROGMEM = {
  // 48x17px
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00,
  0x00, 0x20, 0x78, 0x00, 0x00, 0x00, 0x00, 0x60, 0x7c, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x7e, 0x00,
  0x00, 0x00, 0x01, 0xe0, 0x7f, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x3f, 0x80, 0xff, 0xff, 0x0f, 0xe0,
  0x3f, 0xe7, 0xff, 0xff, 0xff, 0xc0, 0x1f, 0xff, 0x00, 0x01, 0xff, 0xc0, 0x1f, 0xf8, 0x00, 0x00,
  0x7f, 0x80, 0x1f, 0xc0, 0x00, 0x00, 0x1f, 0x80, 0x1e, 0x00, 0x00, 0x00, 0x07, 0x80, 0x38, 0x00,
  0x00, 0x00, 0x03, 0x80, 0x70, 0x00, 0x00, 0x00, 0x01, 0x80, 0xe0, 0x00, 0x00, 0x00, 0x00, 0xc0,
  0xc0, 0x00, 0x00, 0x00, 0x00, 0xc0
};
const unsigned char bird [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x2f, 0x00, 0x7c, 0x00, 0xfc, 0x01, 0xfc, 0x07, 0xf8, 
	0x0f, 0xf8, 0x1f, 0xf0, 0x3f, 0xe0, 0xf1, 0x40, 0xc1, 0x60, 0x01, 0xa0, 0x00, 0x00, 0x00, 0x00
};
const unsigned char bird_0 [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x30, 0x00, 0x38, 0x00, 0x3c, 0x00, 0x3e, 0x08, 0x1f, 0x1c, 0x0f, 0xff, 0x0f, 0xff, 
	0x1f, 0xfc, 0x37, 0xf8, 0x3f, 0xe0, 0x7f, 0xc0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
const unsigned char bird_1 [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x1c, 0x00, 0xfe, 0x0f, 0xf8, 
	0x1f, 0xf8, 0x37, 0xfc, 0x3f, 0xfe, 0x7f, 0xfe, 0x1f, 0x0f, 0x07, 0x07, 0x06, 0x06, 0x04, 0x04
};
const unsigned char bird_2 [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x3c, 0x00, 0x3e, 0x08, 0x7e, 0x1c, 0x7f, 0xfe, 0x7f, 0xfc, 
	0x3f, 0xfc, 0x37, 0xfe, 0x3f, 0xee, 0x7f, 0xcc, 0x1f, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
const unsigned char bird_3 [] PROGMEM = {
	// 16x16px
	0x60, 0x04, 0x70, 0x0c, 0xf8, 0x1e, 0xfc, 0x3e, 0x3c, 0x3c, 0x0e, 0x7c, 0x0e, 0xfe, 0x0f, 0xf8, 
	0x1f, 0xf0, 0x37, 0xf0, 0x3f, 0xe0, 0x7f, 0xc0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
const unsigned char bird_4 [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x00, 0x0c, 0x00, 0x1c, 0x00, 0x3c, 0x10, 0x7c, 0x38, 0xf8, 0xff, 0xf0, 0xff, 0xf0, 
	0x3f, 0xf8, 0x1f, 0xec, 0x07, 0xfc, 0x03, 0xfe, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
const unsigned char bird_5 [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x38, 0x00, 0x7f, 0x00, 0x1f, 0xf0, 
	0x1f, 0xf8, 0x3f, 0xec, 0x7f, 0xfc, 0x7f, 0xfe, 0xf0, 0xf8, 0xe0, 0xe0, 0x60, 0x60, 0x20, 0x20
};
const unsigned char bird_6 [] PROGMEM = {
	// 16x16px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x3c, 0x10, 0x7c, 0x38, 0x7e, 0x7f, 0xfe, 0x3f, 0xfe, 
	0x3f, 0xfc, 0x7f, 0xec, 0x77, 0xfc, 0x33, 0xfe, 0x30, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
const unsigned char bird_7 [] PROGMEM = {
	// 16x16px
	0x20, 0x06, 0x30, 0x0e, 0x78, 0x1f, 0x7c, 0x3f, 0x3c, 0x3c, 0x3e, 0x70, 0x7f, 0x70, 0x1f, 0xf0, 
	0x0f, 0xf8, 0x0f, 0xec, 0x07, 0xfc, 0x03, 0xfe, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
const unsigned char fireball_0 [] PROGMEM = {
  // 24x24px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x80, 0x00, 0x60, 0xc0, 0x01, 0xe1, 0xe0, 0x03, 0xe3, 
	0xf0, 0x03, 0xf7, 0xf0, 0x07, 0xff, 0xf8, 0x07, 0xff, 0xf8, 0x0f, 0xff, 0xf8, 0x0f, 0xff, 0xf8, 
	0x0f, 0xff, 0xf8, 0x0e, 0xff, 0xf8, 0x0f, 0xff, 0xf8, 0x07, 0xbb, 0xf8, 0x07, 0xff, 0x70, 0x03, 
	0xfe, 0xe0, 0x00, 0xff, 0xc0, 0x00, 0x3f, 0x80
};
const unsigned char fireball_1 [] PROGMEM = {
  // 24x24px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc1, 0x00, 0x00, 0xc7, 0x00, 0x00, 
	0x8f, 0x80, 0x00, 0x1f, 0xc0, 0x00, 0x3f, 0xc0, 0x00, 0x7f, 0xe0, 0x00, 0xff, 0xf0, 0x00, 0xff, 
	0xf0, 0x00, 0xff, 0xf8, 0x01, 0xff, 0xf8, 0x01, 0xff, 0xf8, 0x01, 0xff, 0xf8, 0x01, 0xff, 0xf8, 
	0x01, 0xff, 0xf8, 0x01, 0xbf, 0xd8, 0x01, 0xff, 0xf8, 0x00, 0xdf, 0xb0, 0x00, 0xff, 0xf0, 0x00, 
	0x7b, 0xe0, 0x00, 0x1f, 0xc0, 0x00, 0x1f, 0x80
};
const unsigned char fireball_2 [] PROGMEM = {
  // 24x24px
	0x00, 0x80, 0x00, 0x00, 0x41, 0x00, 0x00, 0x43, 0x80, 0x00, 0x07, 0xc0, 0x00, 0x07, 0xc0, 0x00, 
	0x0f, 0xc0, 0x00, 0x1f, 0xc0, 0x00, 0x1f, 0xe0, 0x00, 0x3f, 0xe0, 0x00, 0x3f, 0xe0, 0x00, 0x7f, 
	0xf0, 0x00, 0x7f, 0xf0, 0x00, 0xff, 0xe0, 0x00, 0xff, 0xe0, 0x00, 0xff, 0xe0, 0x00, 0xff, 0xe0, 
	0x00, 0x7f, 0x60, 0x00, 0x7f, 0xc0, 0x00, 0x7f, 0xc0, 0x00, 0x7e, 0xc0, 0x00, 0x2f, 0x80, 0x00, 
	0x3f, 0x80, 0x00, 0x1b, 0x80, 0x00, 0x0f, 0x00
};
const unsigned char fireball_3 [] PROGMEM = {
  // 24x24px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0xc0, 0x00, 0x00, 0xe0, 0x00, 
	0x00, 0xf0, 0x00, 0x00, 0xf0, 0x00, 0x00, 0xf8, 0x00, 0x20, 0xf8, 0x00, 0x61, 0xf8, 0x00, 0xf3, 
	0xf8, 0x00, 0xff, 0xf8, 0x01, 0xff, 0xf8, 0x03, 0xff, 0xf8, 0x03, 0xff, 0xf8, 0x03, 0xff, 0xf0, 
	0x03, 0xff, 0xf0, 0x03, 0xdf, 0xb0, 0x03, 0xff, 0xe0, 0x03, 0xfe, 0xe0, 0x01, 0xbf, 0xc0, 0x00, 
	0xef, 0xc0, 0x00, 0x7f, 0xc0, 0x00, 0x1f, 0x80
};
const unsigned char tree [] PROGMEM = {
	// 32x32px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x80, 0x00, 0x01, 0x00, 0x00, 0x02, 0x00, 0x08, 0x80, 
	0x01, 0x11, 0x05, 0x00, 0x00, 0x82, 0x22, 0x20, 0x00, 0x51, 0x04, 0x00, 0x00, 0x20, 0xa2, 0x00, 
	0x10, 0x00, 0x00, 0x40, 0x08, 0x20, 0x22, 0x88, 0x01, 0x41, 0x41, 0x00, 0x08, 0x80, 0x80, 0x08, 
	0x00, 0x51, 0x01, 0x00, 0x88, 0x20, 0x82, 0x28, 0x40, 0x40, 0x04, 0x10, 0x28, 0xa2, 0x00, 0x22, 
	0x10, 0x14, 0x44, 0x04, 0x08, 0x80, 0x28, 0x28, 0x55, 0x15, 0x11, 0x10, 0x02, 0x8a, 0x00, 0xa0, 
	0x00, 0x41, 0x11, 0x00, 0x00, 0x2a, 0xa2, 0x00, 0x04, 0x50, 0x05, 0x40, 0x02, 0x82, 0xa8, 0x00, 
	0x05, 0x11, 0x50, 0x00, 0x00, 0x0a, 0x8a, 0x00, 0x00, 0x05, 0x01, 0x00, 0x00, 0x0a, 0x00, 0x00, 
	0x00, 0x05, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x15, 0x00, 0x00, 0x00, 0x2a, 0x80, 0x00
};
const unsigned char grass [] PROGMEM = {
	// 16x8px
	0x00, 0x00, 0x00, 0x00, 0x08, 0x20, 0x08, 0x40, 0x44, 0x28, 0x24, 0xa4, 0x24, 0xa4, 0x2d, 0xac
};
const unsigned char vitamins [] PROGMEM = {
	// 12x11px
	0x7f, 0xe0, 0x3f, 0xc0, 0x7f, 0xe0, 0x40, 0x20, 0x7f, 0xe0, 0x55, 0x60, 0x6a, 0xa0, 0x55, 0x60, 
	0x7f, 0xe0, 0x40, 0x20, 0x3f, 0xc0
};
const unsigned char block [] PROGMEM = {
	// 4x4px
	0xf0, 0xf0, 0xf0, 0xf0
};

unsigned long previousAnimationMillis = 0;
const int animationDelay = 16;
int currentFrame = 0;

unsigned long previousGameMillis = 0;
int gameDelay = 2000;

const int leftBtn = 0;
const int backBtn = 1;
const int selectBtn = 2;
const int rightBtn = 3;

const int birdFrames = 48;

int birdStartPos = 50;
int birdEndPos = 50;
int fireballEndPos;

int previousBirdX = 0;
int previousBirdY = 0;

unsigned long previousSystemDelayMillis = 0;
int systemDelayInterval = 300;
bool btnCooldown = false;

bool gameSetup = false;
bool rightSide = false;
bool hit = false;

int currentFireFrame = 0;

void setup() {

  randomSeed(analogRead(0));
  birdStartPos = getRandomNumber(30, 80);
  delay(20);
  birdEndPos = getRandomNumber(30, 80);

  Serial.begin(9600);

  pinMode(leftBtn, INPUT_PULLUP);
  pinMode(rightBtn, INPUT_PULLUP);
  pinMode(selectBtn, INPUT_PULLUP);
  pinMode(backBtn, INPUT_PULLUP);

  delay(500);                        // wait for the OLED to power up
  display.begin(i2c_Address, true);  // Address 0x3C default
  display.setContrast(0);            // dim display
  display.setRotation(1);
  display.setTextColor(SH110X_WHITE);
  display.setTextSize(1);

  display.clearDisplay();
  display.display();

  delay(3000);
  
}

void loop() {

  renderFireball();

  unsigned long systemDelayMillis = millis();
  unsigned long animationMillis = millis();
  unsigned long gameMillis = millis();

  if (systemDelayMillis - previousSystemDelayMillis >= systemDelayInterval) {
    previousSystemDelayMillis = systemDelayMillis;  // reset the timer

    btnCooldown = false;
  }
  
  if (animationMillis - previousAnimationMillis >= animationDelay) {
    previousAnimationMillis = animationMillis;  // reset the timer

    currentFrame++;
    currentFireFrame++;
    if (currentFrame >= birdFrames) {      

      rightSide = !rightSide;

      currentFrame = 0;
      birdStartPos = birdEndPos;
      birdEndPos = getRandomNumber(30, 90);
    }

    if (currentFireFrame >= 16) {
      currentFireFrame = 0;
    }
    
  }

  if (gameMillis - previousGameMillis >= gameDelay) {
    previousGameMillis = gameMillis;  // Reset the timer

    if(hit){
      hit = false;
      currentFrame = 0;
      birdStartPos = getRandomNumber(30, 90);
      delay(10);
      birdEndPos = getRandomNumber(30, 90);
    }
  }

  if(digitalRead(selectBtn) == LOW && btnCooldown == false && gameSetup == true){
    btnCooldown = true;
    previousSystemDelayMillis = systemDelayMillis;

    if((currentFrame >= 10 && currentFrame <= 14) || (currentFrame >= 34 && currentFrame <= 38) ){
      hit = true;
      previousGameMillis = gameMillis;
      
      fireballEndPos = birdEndPos;

      Serial.print("current frame: ");
      Serial.println(currentFrame);

      if(rightSide){
        // Serial.print("current frame: ");
        // Serial.println(currentFrame);  
      }
    }
  }
}

void renderFireball() {

  if(gameSetup == false){
    birdStartPos = getRandomNumber(30, 90);
    delay(10);
    birdEndPos = getRandomNumber(30, 90);

    gameSetup = true;
  }

  int offset = birdStartPos - birdEndPos;
  float offsetAmount = (float)offset / birdFrames;

  display.clearDisplay();

  display.drawBitmap(2, 10, fireball_bar, 62, 11, 1);
  display.drawBitmap(10, 108, devil_head, 48, 17, 1);

  float yPos = birdStartPos + (offsetAmount * ((float)currentFrame + 1) * -1);
  float yPosIn8;


  if(offset >= 0){
    yPosIn8 = birdStartPos + (offsetAmount * ((float)currentFrame + 9) * -1);  
  }else{
    yPosIn8 = birdStartPos + (offsetAmount * ((float)currentFrame + 17) * -1);  
  }

  // Serial.print("y position: ");
  // Serial.println(round(yPos));
  // Serial.print("y position in 8 frames: ");
  // Serial.println(round(yPosIn8));

  const unsigned char* fireball_frames[] = { fireball_0, fireball_0, fireball_0, fireball_0, fireball_1, fireball_1, fireball_1, fireball_1, fireball_2, fireball_2, fireball_2, fireball_2, fireball_3, fireball_3, fireball_3, fireball_3 };
  const unsigned char* bird_frames_right[] = { bird_0, bird_0, bird_0, bird_0, bird_1, bird_1, bird_1, bird_1, bird_2, bird_2, bird_2, bird_2, bird_3, bird_3, bird_3, bird_3 };
  const unsigned char* bird_frames_left[] = { bird_4, bird_4, bird_4, bird_4, bird_5, bird_5, bird_5, bird_5, bird_6, bird_6, bird_6, bird_6, bird_7, bird_7, bird_7, bird_7 };

  if(hit){

    display.drawBitmap(previousBirdX - 4, previousBirdY - 6, fireball_frames[currentFireFrame], 24, 24, 1);

  }else{

    display.drawBitmap(20, 96, fireball_frames[currentFireFrame], 24, 24, 1);

    if (currentFrame < birdFrames/2) {
      display.drawRect(((currentFrame * 2.6) + 2), 10, 2, 11, SH110X_WHITE);
    }else{
      display.drawRect(((opposite(currentFrame) * 2.6) + 2), 10, 2, 11, SH110X_WHITE);
    }

    if (rightSide) {
      previousBirdX = 48 - currentFrame;
      previousBirdY = round(yPos);
      // display.drawBitmap((48 - (currentFrame + 8)), round(yPosIn8), block, 4, 4, 1);
      display.drawBitmap((48 - currentFrame), round(yPos), bird_frames_right[currentFireFrame], 16, 16, 1);
    } else {
      previousBirdX = currentFrame;
      previousBirdY = round(yPos);
      // display.drawBitmap((currentFrame + 20), round(yPosIn8), block, 4, 4, 1);
      display.drawBitmap(currentFrame, round(yPos), bird_frames_left[currentFireFrame], 16, 16, 1);
    }
  }

  display.drawBitmap(-12, 40, tree, 32, 32, 1);
  display.drawBitmap(40, 60, tree, 32, 32, 1);
  display.drawBitmap(12, 75, grass, 16, 8, 1);
  // display.drawBitmap(26, 40, grass, 16, 8, 1);
  // display.drawBitmap(38, 40, grass, 16, 8, 1);

  display.display();
}

int opposite(int x) {
  if (x < 0 || x > 47) {
    return -1; // Return -1 for out of range
  }
  return 47 - x;
}

int getRandomNumber(int minVal, int maxVal) {
  return random(minVal, maxVal + 1);  // maxValue + 1 to include maxValue in the range
}